Backport of:

From 5977610de1aa87630e40a299a2d90fb7cd00bf7c Mon Sep 17 00:00:00 2001
From: "Christoph M. Becker" <cmbecker69@gmx.de>
Date: Mon, 9 Aug 2021 12:48:21 +0200
Subject: [PATCH] Fix #74544: Integer overflow in mysqli_real_escape_string()

The patch has been provided by @johannes.

Closes GH-7353.
---
 NEWS                    | 4 ++++
 ext/mysqli/mysqli_api.c | 2 +-
 2 files changed, 5 insertions(+), 1 deletion(-)

#diff --git a/NEWS b/NEWS
#index 28341f26c94c..cb5132397221 100644
#--- a/NEWS
#+++ b/NEWS
#@@ -18,6 +18,10 @@ PHP                                                                        NEWS
# - GD:
#   . Fixed bug #51498 (imagefilledellipse does not work for large circles). (cmb)
# 
#+- MySQLi:
#+  . Fixed bug #74544 (Integer overflow in mysqli_real_escape_string()). (cmb,
#+    johannes)
#+
# - OpenSSL:
#   . Fixed bug #81327 (Error build openssl extension on php 7.4.22). (cmb)
# 
--- a/ext/mysqli/mysqli_api.c
+++ b/ext/mysqli/mysqli_api.c
@@ -1956,7 +1956,7 @@ PHP_FUNCTION(mysqli_real_escape_string)
 	}
 	MYSQLI_FETCH_RESOURCE_CONN(mysql, mysql_link, MYSQLI_STATUS_VALID);
 
-	newstr = zend_string_alloc(2 * escapestr_len, 0);
+	newstr = zend_string_safe_alloc(2, escapestr_len, 0, 0);
 	ZSTR_LEN(newstr) = mysql_real_escape_string(mysql->mysql, ZSTR_VAL(newstr), escapestr, escapestr_len);
 	newstr = zend_string_truncate(newstr, ZSTR_LEN(newstr), 0);
 
